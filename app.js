const { createBot, createProvider, createFlow, addKeyword, EVENTS } = require('@bot-whatsapp/bot')
require('dotenv').config()

const QRPortalWeb = require('@bot-whatsapp/portal')
const BaileysProvider = require('@bot-whatsapp/provider/baileys')
//const MockAdapter = require('@bot-whatsapp/database/mock')
const MongoAdapter = require('@bot-whatsapp/database/mongo')
const { MongoClient } = require('mongodb')

const path = require('path')
const fs = require('fs')
const chat = require('./ChatGPT.js')
const { handlerAI } = require('./whisper.js')

// Agregar librer√≠a para eliminar acentos
const removeAccents = require('remove-accents')

// Leer archivos de texto de forma segura
function safeReadTxt(filePath, fallback) {
    try {
        return fs.readFileSync(path.join(__dirname, "mensajes", filePath), 'utf-8')
    } catch (e) {
        return fallback || 'Mensaje no disponible en este momento.'
    }
}

const menu = safeReadTxt("menu.txt", "Bienvenido a Smartcell Academy. ¬øEn qu√© podemos ayudarte hoy?");
const promptConsultas = safeReadTxt("promptConsultas.txt", "Haz tu consulta.");
const cursoText = safeReadTxt("curso.txt", "Nuestros cursos est√°n dise√±ados para ti.");
const reparacionesText = safeReadTxt("reparaciones.txt", "Ofrecemos servicios de reparaci√≥n profesional.");
const tiendaText = safeReadTxt("tienda.txt", "Bienvenido a nuestra tienda t√©cnica.");

const opcionesValidas = ["1", "2", "3", "4", "0"]

// Conexi√≥n personalizada a MongoDB para consultas de productos/servicios
let db
(async () => {
    const client = new MongoClient(process.env.MONGO_DB_URI, { useUnifiedTopology: true })
    await client.connect()
    db = client.db('whatsappTEST') // Cambia si tu base real tiene otro nombre
})()

// Buscar √≠tem en MongoDB (mejorado para variantes)
async function buscarItem(mensaje) {
    if (!db) return null
    const texto = removeAccents(mensaje.trim().toLowerCase())
    // Busca en cursos
    let item = await db.collection('cursos').findOne({ nombre: { $regex: texto, $options: 'i' } })
    if (item) return { tipo: 'curso', ...item }
    // Busca en reparaciones
    item = await db.collection('reparaciones').findOne({ nombre: { $regex: texto, $options: 'i' } })
    if (item) return { tipo: 'reparacion', ...item }
    // Busca en herramientas
    item = await db.collection('herramientas').findOne({ nombre: { $regex: texto, $options: 'i' } })
    if (item) return { tipo: 'herramienta', ...item }
    return null
}

// Detecci√≥n de intenci√≥n desde texto (mejorada)
const detectarIntencion = (text) => {
    const lower = removeAccents(text.toLowerCase())

    const intenciones = [
        { keywords: ["curso", "cursos", "clase", "brochure", "estudiar", "capacitacion"], flow: "curso" },
        { keywords: ["reparar", "reparacion", "falla", "arreglar", "celular", "pantalla", "laptop", "pc", "computadora"], flow: "reparaciones" },
        { keywords: ["comprar", "precio", "herramienta", "vender", "producto", "tienda", "multimetro", "kit", "soldadura"], flow: "tienda" },
        { keywords: ["consulta", "duda", "pregunta", "informacion", "ayuda", "soporte"], flow: "consultas" },
    ]

    for (const item of intenciones) {
        if (item.keywords.some(p => lower.includes(p))) {
            return item.flow
        }
    }

    return null
}

// FLOW: Cursos
const flowCurso = addKeyword(EVENTS.ACTION)
    .addAnswer(cursoText, { capture: true, buttons: [
        { body: "Ver men√∫" },
        { body: "Consultar" },
        { body: "Tienda" },
        { body: "Salir" },
    ] }, async (ctx, ctxFn) => {
        try {
            const input = ctx.body.trim();

            const brochures = {
                "1": {
                    nombre: "Reparaci√≥n de Laptops y PCs",
                    archivo: path.join(__dirname, "mensajes/pdfs/Brochure_reparacion_de_computadoras.pdf"),
                },
                "2": {
                    nombre: "Reparaci√≥n de Celulares y Tablets",
                    archivo: path.join(__dirname, "mensajes/pdfs/Brochure_de_reparacion_de_celulares.pdf"),
                },
                "3": {
                    nombre: "Electr√≥nica",
                    archivo: path.join(__dirname, "mensajes/pdfs/Brochure_electronica.pdf"),
                },
                "4": {
                    nombre: "Rob√≥tica",
                    archivo: path.join(__dirname, "mensajes/pdfs/Brochure_robotica.pdf"),
                },
            }
            
            const brochure = brochures[input];

            if (!brochure || !fs.existsSync(brochure.archivo)) {
                return ctxFn.flowDynamic("‚ùå Opci√≥n no v√°lida. Por favor escribe 1, 2, 3 o 4.");
            }

            await ctxFn.flowDynamic([
                {
                    body: `üìÑ Aqu√≠ tienes el brochure del curso *${brochure.nombre}*`,
                    media: brochure.archivo,
                }
            
            ])
            return await ctxFn.flowDynamic("¬øDeseas consultar sobre otro curso?");
        } catch (error) {
            console.error("‚ùå Error al enviar el brochure:", error);
            await ctxFn.flowDynamic("Ocurri√≥ un error al intentar enviarte el brochure. Intenta de nuevo m√°s tarde.");
        }
    });

// FLOW: Reparaciones
const flowReparaciones = addKeyword(EVENTS.ACTION)
    .addAnswer(reparacionesText, { buttons: [
        { body: "Ver men√∫" },
        { body: "Consultar" },
        { body: "Tienda" },
        { body: "Salir" },
    ] })

// FLOW: Tienda
const flowTienda = addKeyword(EVENTS.ACTION)
    .addAnswer(tiendaText, { buttons: [
        { body: "Ver men√∫" },
        { body: "Consultar" },
        { body: "Ver cursos" },
        { body: "Salir" },
    ] })

// FLOW: Consultas
const flowConsultas = addKeyword(EVENTS.ACTION)
    .addAnswer("Haz una consulta", { capture: true, buttons: [
        { body: "Ver men√∫" },
        { body: "Ver cursos" },
        { body: "Tienda" },
        { body: "Salir" },
    ] }, async (ctx, ctxFn) => {
        const answer = await chat(promptConsultas, ctx.body);
        if (!answer?.content) {
            return await ctxFn.flowDynamic("‚ùå No se pudo generar una respuesta. Intenta nuevamente.");
        }
        await ctxFn.flowDynamic(answer.content);
    });

// FLOW: Nota de voz
const flowVoice = addKeyword(EVENTS.VOICE_NOTE).addAnswer("üé§ Procesando tu nota de voz....", null, async (ctx, ctxFn) => {
    const transcripcion  = await handlerAI(ctx);

    if (transcripcion === "ERROR") {
        return await ctxFn.flowDynamic("‚ùå Ocurri√≥ un error al procesar tu nota de voz.");
    }

    const intencion = detectarIntencion(transcripcion);

    switch (intencion) {
        case "curso":
            return gotoFlow(flowCurso);
        case "reparaciones":
            return gotoFlow(flowReparaciones);
        case "tienda":
            return gotoFlow(flowTienda);
        case "consulta":
            return gotoFlow(flowConsultas);
        default:
            return await flowDynamic("ü§ñ No entend√≠ tu mensaje. ¬øPodr√≠as reformularlo o escribir *menu*?");
    }
});

// FLOW: Bienvenida mejorado para detectar mensajes directos desde la web
const flowWelcome = addKeyword(EVENTS.WELCOME)
    .addAnswer(menu, { capture: true, buttons: [
        { body: "Ver cursos" },
        { body: "Reparaciones" },
        { body: "Consultar" },
        { body: "Tienda" },
        { body: "Salir" },
    ] }, async (ctx, {gotoFlow,fallBack,flowDynamic}) => {
        // Si el usuario llega con un mensaje personalizado (desde la web)
        if (ctx.body && ctx.body.length > 2) {
            const item = await buscarItem(ctx.body);
            if (item) {
                await flowDynamic([
                    { body: menu },
                    { body: `*${item.tipo.toUpperCase()}*: ${item.nombre}\n${item.descripcion || ''}\nPrecio: S/ ${item.precio || 'Consultar'}` },
                    { body: "¬øDeseas m√°s informaci√≥n, consultar sobre otro producto/servicio o ver el men√∫?", buttons: [
                        { body: "Consultar" },
                        { body: "Ver men√∫" },
                        { body: "Volver" },
                    ] }
                ]);
                return;
            }
        }
        // Normalizar para botones
        const normalized = removeAccents(ctx.body.toLowerCase());
        if (["ver cursos", "1"].includes(normalized)) return gotoFlow(flowCurso);
        if (["reparaciones", "2"].includes(normalized)) return gotoFlow(flowReparaciones);
        if (["consultar", "3"].includes(normalized)) return gotoFlow(flowConsultas);
        if (["tienda", "4"].includes(normalized)) return gotoFlow(flowTienda);
        if (["salir", "0"].includes(normalized)) return await flowDynamic("Gracias por tu visita. Puedes volver a escribir *Menu* cuando lo necesites.");
        return fallBack("Respuesta no v√°lida, elige una opci√≥n del men√∫ o usa los botones.");
    });

// FLOW: Men√∫ (permite volver a mostrar el men√∫ y reiniciar contexto)
const menuFlow = addKeyword("Menu").addAnswer(
    menu,
    { capture: true, buttons: [
        { body: "Ver cursos" },
        { body: "Reparaciones" },
        { body: "Consultar" },
        { body: "Tienda" },
        { body: "Salir" },
    ] },
    async (ctx, {gotoFlow,fallBack,flowDynamic}) => {
        const normalized = removeAccents(ctx.body.toLowerCase());
        if (["ver cursos", "1"].includes(normalized)) return gotoFlow(flowCurso);
        if (["reparaciones", "2"].includes(normalized)) return gotoFlow(flowReparaciones);
        if (["consultar", "3"].includes(normalized)) return gotoFlow(flowConsultas);
        if (["tienda", "4"].includes(normalized)) return gotoFlow(flowTienda);
        if (["salir", "0"].includes(normalized)) return await flowDynamic("Saliendo... Puedes volver a acceder a este men√∫ escribiendo '*Menu*'");
        return fallBack("Respuesta no valida, elige una de las opciones del menu o usa los botones");
    }
)
    
// Inicializaci√≥n del bot
const main = async () => {
    const adapterDB = new MongoAdapter({
        dbUri: process.env.MONGO_DB_URI,
        dbname: "whatsappTEST"
    })
    const adapterFlow = createFlow([flowWelcome, menuFlow, flowCurso, flowReparaciones, flowTienda, flowConsultas, flowVoice])   
    const adapterProvider = createProvider(BaileysProvider)

    createBot({
        flow: adapterFlow,
        provider: adapterProvider,
        database: adapterDB,
    })

    QRPortalWeb()
}

main()